<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UmbrellaAI</title>
    <style>
        /* --- 1. –§–û–ù --- */
        body {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', sans-serif;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            transition: background 1.5s ease;
            background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%);
        }
        body.stormy { background: linear-gradient(to bottom, #1e3c72, #2a5298); }
        body.snowy { background: linear-gradient(to bottom, #83a4d4, #b6fbff); }

        /* --- 2. –ñ–ò–î–ö–û–ï –°–¢–ï–ö–õ–û --- */
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            width: 360px; text-align: center;
            position: relative; z-index: 50; overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            /* –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –¥–µ—Ä–≥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –∞–Ω–∏–º–∞—Ü–∏–∏ */
            backface-visibility: hidden; transform-style: preserve-3d;
        }

        /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –º—ã—à–∏ */
        .glass-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: -1;
            background: radial-gradient(600px circle at var(--mouse-x) var(--mouse-y), rgba(255, 255, 255, 0.35), transparent 40%);
            opacity: 0; transition: opacity 0.5s ease;
        }
        .glass-card:hover::before { opacity: 1; }
        .glass-card:hover { transform: translateY(-3px); box-shadow: 0 15px 45px rgba(0,0,0,0.25); }

        /* --- –ê–ù–ò–ú–ê–¶–ò–Ø –ñ–ï–õ–ï (LIQUID SHAKE) --- */
        /* –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –∫–∞—Ä—Ç–æ—á–∫–µ, –∏–Ω–ø—É—Ç—É –∏ –∫–Ω–æ–ø–∫–µ */
        .jelly-active {
            animation: liquidShake 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }

        @keyframes liquidShake {
            0% { transform: scale(1); }
            30% { transform: scale(1.08, 0.92); } /* –°–ø–ª—é—â–∏–≤–∞–Ω–∏–µ */
            50% { transform: scale(0.95, 1.05); } /* –†–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏–µ */
            70% { transform: scale(1.02, 0.98); }
            100% { transform: scale(1); }
        }

        /* --- 3. –ò–ù–¢–ï–†–§–ï–ô–° --- */
        .interface-container { display: flex; flex-direction: column; gap: 20px; z-index: 50; }
        .card-main { padding: 30px; }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –ö–Ω–æ–ø–∫–∞ */
        .input-group { display: flex; gap: 10px; margin-bottom: 5px; position: relative; z-index: 2; }
        
        input { 
            flex: 1; padding: 12px 15px; border-radius: 12px; 
            border: 1px solid rgba(255, 255, 255, 0.3); 
            background: rgba(255, 255, 255, 0.2); 
            color: #333; font-size: 16px; outline: none; 
            transition: background 0.3s, box-shadow 0.3s; 
            backdrop-filter: blur(5px); 
        }
        input:focus { background: rgba(255, 255, 255, 0.5); box-shadow: 0 0 15px rgba(255, 255, 255, 0.3); }
        
        button { 
            padding: 12px 18px; border-radius: 12px; 
            border: 1px solid rgba(255,255,255,0.4); 
            background: rgba(255, 255, 255, 0.3); 
            color: #fff; font-size: 18px; cursor: pointer; 
            transition: background 0.3s; 
            font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.1); 
        }
        button:hover { background: rgba(255, 255, 255, 0.6); }

        /* –†–∞—Å–∫—Ä—ã—Ç–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (Liquid Reveal) */
        .weather-info {
            max-height: 0; opacity: 0; overflow: hidden; transform: translateY(-10px); filter: blur(10px);
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .weather-info.visible {
            max-height: 200px; opacity: 1; transform: translateY(0); filter: blur(0);
            margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.3);
        }

        .card-advice {
            padding: 20px; opacity: 0; transform: translateY(-20px) scale(0.9); filter: blur(15px);
            transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: none;
            border-left: 8px solid rgba(255, 255, 255, 0.5);
        }
        .card-advice.visible { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); pointer-events: auto; }

        h1 { margin: 0 0 20px 0; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.1); font-weight: 600; letter-spacing: 1px; }
        .city-label { font-size: 18px; color: rgba(0, 0, 0, 0.7); font-weight: 500; margin-bottom: 5px; }
        .temp { font-size: 64px; font-weight: 800; letter-spacing: -2px; background: -webkit-linear-gradient(#fff, #eee); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        .advice-title { font-size: 22px; font-weight: bold; margin-bottom: 5px; display: block; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .advice-desc { color: rgba(0, 0, 0, 0.6); font-size: 15px; font-weight: 500; }

        /* --- 4. –ü–ï–ô–ó–ê–ñ --- */
        .landscape { position: absolute; bottom: 0; left: 0; width: 100%; height: 400px; pointer-events: none; z-index: 10; }
        .mountain { position: absolute; bottom: 0; width: 0; height: 0; border-left: 150px solid transparent; border-right: 150px solid transparent; border-bottom: 250px solid #95a5a6; z-index: 1; transition: border-bottom-color 1.5s ease; }
        .m1 { left: -50px; bottom: 50px; transform: scale(1.2); border-bottom-color: #7f8c8d; }
        .m2 { left: 15%; bottom: 40px; transform: scale(0.8); border-bottom-color: #bdc3c7; }
        .m3 { right: 0; bottom: 60px; transform: scale(1.5); border-bottom-color: #95a5a6; }
        .hill { position: absolute; border-radius: 50%; transition: background 1.5s ease; }
        .hill-bg { width: 120vw; height: 500px; left: -10vw; bottom: -280px; background: linear-gradient(to top, #27ae60 20%, #2ecc71 100%); z-index: 2; }
        .hill-fg { width: 140vw; height: 400px; right: -20vw; bottom: -250px; background: linear-gradient(to top, #1e8449 20%, #27ae60 100%); z-index: 3; box-shadow: 0 -10px 50px rgba(0,0,0,0.1); }
        .tree-container { position: absolute; bottom: 130px; z-index: 4; transition: transform 1.5s ease; }
        .trunk { width: 10px; height: 20px; background: #5d4037; margin: 0 auto; }
        .foliage { width: 0; height: 0; border-left: 25px solid transparent; border-right: 25px solid transparent; border-bottom: 80px solid #145a32; margin-bottom: -10px; position: relative; transition: border-bottom-color 1.5s ease; }
        .foliage::after { content: ''; position: absolute; left: 0; top: 0; border-left: 0 solid transparent; border-right: 25px solid transparent; border-bottom: 80px solid rgba(0,0,0,0.1); width: 0; height: 0; transform: translate(-50%, 0); margin-left: 0; margin-top: 0; }
        .tc1 { left: 5%; bottom: 120px; transform: scale(0.8); } .tc2 { left: 15%; bottom: 100px; transform: scale(1.1); } .tc3 { left: 25%; bottom: 140px; transform: scale(0.6); } .tc4 { right: 10%; bottom: 110px; transform: scale(1.0); } .tc5 { right: 25%; bottom: 130px; transform: scale(0.7); } .tc6 { right: 35%; bottom: 90px; transform: scale(1.2); }

        body.stormy .mountain { border-bottom-color: #2c3e50; }
        body.stormy .hill-bg { background: linear-gradient(to top, #1a252f, #2c3e50); }
        body.stormy .hill-fg { background: linear-gradient(to top, #000, #1a252f); }
        body.stormy .trunk { background: #222; }
        body.stormy .foliage { border-bottom-color: #0d2315; }
        body.snowy .mountain { border-bottom-color: #ecf0f1; }
        body.snowy .hill-bg { background: linear-gradient(to top, #bdc3c7, #ecf0f1); }
        body.snowy .hill-fg { background: linear-gradient(to top, #95a5a6, #bdc3c7); }
        body.snowy .trunk { background: #444; }
        body.snowy .foliage { border-bottom-color: #7f8c8d; }

        /* --- 5. –≠–§–§–ï–ö–¢–´ --- */
        #sunSystem { position: absolute; top: 50px; right: 50px; width: 150px; height: 150px; z-index: 5; pointer-events: none; transition: opacity 1s, transform 1s; }
        .the-sun { width: 100px; height: 100px; background: radial-gradient(circle at 30% 30%, #ffd700, #f1c40f); border-radius: 50%; position: absolute; top: 25px; left: 25px; box-shadow: 0 0 40px #f39c12; animation: sunPulse 4s ease-in-out infinite; }
        .sun-rays-ring { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: repeating-conic-gradient(from 0deg, rgba(255, 215, 0, 0) 0deg, rgba(255, 215, 0, 0.3) 10deg, rgba(255, 215, 0, 0) 20deg); border-radius: 50%; animation: sunSpin 20s linear infinite; }
        @keyframes sunSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes sunPulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        body.stormy #sunSystem, body.snowy #sunSystem { opacity: 0; transform: translateY(-100px); }

        .rain-drop { position: absolute; background-color: rgba(255, 255, 255, 0.4); width: 2px; height: 20px; top: -50px; animation: fall linear infinite; z-index: 20; }
        .snow-flake { position: absolute; background-color: white; border-radius: 50%; top: -10px; animation: fall linear infinite; z-index: 20; }
        @keyframes fall { to { transform: translateY(110vh); } }
        .cloud { position: absolute; background: #ecf0f1; border-radius: 100px; opacity: 0.8; z-index: 15; animation: drift linear infinite; backdrop-filter: blur(2px); }
        .cloud.dark { background: #58636d; opacity: 0.8; }
        .cloud::after, .cloud::before { content: ''; position: absolute; background: inherit; z-index: -1; }
        .cloud::after { width: 40%; height: 40%; top: -20%; left: 15%; border-radius: 50%; } .cloud::before { width: 60%; height: 60%; top: -35%; right: 15%; border-radius: 50%; }
        @keyframes drift { from { transform: translateX(-200px); } to { transform: translateX(110vw); } }
        .flash-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: white; opacity: 0; pointer-events: none; z-index: 30; }
        .flashing { animation: lightning 0.8s ease-out; }
        @keyframes lightning { 0% { opacity: 0; } 10% { opacity: 0.7; } 100% { opacity: 0; } }
    </style>
</head>
<body id="mainBody">

    <div id="sunSystem"><div class="sun-rays-ring"></div><div class="the-sun"></div></div>
    <div id="cloudsContainer"></div>
    <div id="precipContainer"></div>
    <div class="flash-overlay" id="flashOverlay"></div>
    
    <div class="landscape">
        <div class="mountain m1"></div><div class="mountain m2"></div><div class="mountain m3"></div>
        <div class="hill hill-bg"></div><div class="hill hill-fg"></div>
        <div class="tree-container tc1"><div class="foliage"></div><div class="trunk"></div></div>
        <div class="tree-container tc2"><div class="foliage"></div><div class="trunk"></div></div>
        <div class="tree-container tc3"><div class="foliage"></div><div class="trunk"></div></div>
        <div class="tree-container tc4"><div class="foliage"></div><div class="trunk"></div></div>
        <div class="tree-container tc5"><div class="foliage"></div><div class="trunk"></div></div>
        <div class="tree-container tc6"><div class="foliage"></div><div class="trunk"></div></div>
    </div>

    <div class="interface-container">
        
        <!-- CARD 1 -->
        <!-- onclick="triggerJelly(this)" –∑–∞–ø—É—Å–∫–∞–µ—Ç –∂–µ–ª–µ –Ω–∞ —Å–∞–º–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω -->
        <div class="glass-card card-main" onclick="triggerJelly(this)">
            <h1>üå§Ô∏è UmbrellaAI</h1>
            <div class="input-group">
                <!-- –í–ê–ñ–ù–û: onclick="triggerJelly(this); event.stopPropagation()" 
                     –∑–∞–ø—É—Å–∫–∞–µ—Ç –∂–µ–ª–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –∏–Ω–ø—É—Ç–µ –∏ –Ω–µ –¥–∞–µ—Ç —Å—Ä–∞–±–æ—Ç–∞—Ç—å –∂–µ–ª–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ -->
                <input type="text" id="cityInput" list="cities" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞..." 
                       oninput="handleInput(this.value)" autocomplete="off"
                       onclick="triggerJelly(this); event.stopPropagation()">
                
                <button onclick="checkWeather(); triggerJelly(this); event.stopPropagation()">‚ûî</button>
            </div>
            <datalist id="cities"></datalist>

            <div class="weather-info" id="weatherInfo">
                <div class="city-label" id="cityName">–ì–æ—Ä–æ–¥</div>
                <div class="temp"><span id="tempVal">0</span>¬∞</div>
            </div>
        </div>

        <!-- CARD 2 -->
        <div class="glass-card card-advice" id="adviceCard" onclick="triggerJelly(this)">
            <span class="advice-title" id="adviceTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            <span class="advice-desc">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Å–∞–¥–∫–æ–≤: <span id="probVal">0</span>%</span>
        </div>

    </div>

    <script>
        // --- 1. –ê–ù–ò–ú–ê–¶–ò–Ø –ñ–ï–õ–ï (–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è) ---
        function triggerJelly(element) {
            // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å (—Å–±—Ä–æ—Å)
            element.classList.remove('jelly-active');
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç (Reflow)
            void element.offsetWidth;
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å
            element.classList.add('jelly-active');
        }

        // --- 2. –ü–û–î–°–í–ï–¢–ö–ê –ú–´–®–ò (–¢–æ–ª—å–∫–æ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫) ---
        document.querySelectorAll('.glass-card').forEach(card => {
            card.addEventListener('mousemove', e => {
                const rect = card.getBoundingClientRect();
                card.style.setProperty('--mouse-x', `${e.clientX - rect.left}px`);
                card.style.setProperty('--mouse-y', `${e.clientY - rect.top}px`);
            });
        });

        // --- –õ–û–ì–ò–ö–ê ---
        let debounceTimer;
        async function handleInput(query) {
            if (query.length < 2) return;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(async () => { await fetchCities(query); }, 300);
        }
        async function fetchCities(query) {
            const dl = document.getElementById('cities');
            try {
                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${query}&count=5&language=ru&format=json`);
                const data = await res.json();
                dl.innerHTML = '';
                if (data.results) data.results.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.name; opt.label = c.name + (c.country ? ` (${c.country})` : '');
                    dl.appendChild(opt);
                });
            } catch(e) {}
        }

        async function checkWeather() {
            const city = document.getElementById('cityInput').value;
            const btn = document.querySelector('button');
            const infoBlock = document.getElementById('weatherInfo');
            const adviceCard = document.getElementById('adviceCard');

            if(!city) return;
            btn.disabled = true; 

            try {
                const res = await fetch(`/predict?city=${city}`);
                const data = await res.json();
                if (data.error) { alert(data.error); return; }

                document.getElementById('cityName').textContent = data.city;
                document.getElementById('tempVal').textContent = Math.round(data.temp);
                document.getElementById('probVal').textContent = data.prob;
                
                infoBlock.classList.add('visible');
                setTimeout(() => { adviceCard.classList.add('visible'); }, 200);

                setWeatherState(data.rain_predicted, data.temp);
            } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"); } 
            finally { btn.disabled = false; }
        }

        let precipInterval, cloudInterval, lightningTimeout;

        function setWeatherState(hasPrecipitation, temp) {
            const body = document.getElementById('mainBody');
            const adviceCard = document.getElementById('adviceCard');
            const adviceTitle = document.getElementById('adviceTitle');
            
            stopAllEffects();
            adviceTitle.style.color = "#fff";

            if (hasPrecipitation) {
                if (temp < 0) {
                    body.className = 'snowy';
                    adviceTitle.textContent = "üå®Ô∏è –û–∂–∏–¥–∞–µ—Ç—Å—è —Å–Ω–µ–≥";
                    adviceCard.style.borderLeftColor = "#00d2ff"; 
                    startSnow(); startClouds(false);
                } else {
                    body.className = 'stormy';
                    adviceTitle.textContent = "‚òî –ë–µ—Ä–∏ –∑–æ–Ω—Ç!";
                    adviceCard.style.borderLeftColor = "#3a7bd5"; 
                    startRain(); startClouds(true); startLightning();
                }
            } else {
                body.className = '';
                adviceTitle.textContent = "‚òÄÔ∏è –ó–æ–Ω—Ç –Ω–µ –Ω—É–∂–µ–Ω";
                adviceCard.style.borderLeftColor = "#f1c40f"; 
            }
        }

        function stopAllEffects() {
            clearInterval(precipInterval); clearInterval(cloudInterval); clearTimeout(lightningTimeout);
            document.getElementById('precipContainer').innerHTML = '';
            document.getElementById('cloudsContainer').innerHTML = '';
        }
        function startRain() {
            const cont = document.getElementById('precipContainer');
            precipInterval = setInterval(() => {
                const drop = document.createElement('div'); drop.classList.add('rain-drop');
                drop.style.left = Math.random() * 100 + "vw"; drop.style.animationDuration = (Math.random() * 0.5 + 0.4) + "s"; drop.style.opacity = Math.random();
                cont.appendChild(drop); setTimeout(() => drop.remove(), 900);
            }, 20);
        }
        function startSnow() {
            const cont = document.getElementById('precipContainer');
            precipInterval = setInterval(() => {
                const flake = document.createElement('div'); flake.classList.add('snow-flake');
                const size = Math.random() * 5 + 3 + "px"; flake.style.width = size; flake.style.height = size;
                flake.style.left = Math.random() * 100 + "vw"; flake.style.animationDuration = (Math.random() * 5 + 3) + "s"; flake.style.opacity = Math.random() * 0.7 + 0.3;
                cont.appendChild(flake); setTimeout(() => flake.remove(), 8000);
            }, 50);
        }
        function startClouds(isDark) {
            const cont = document.getElementById('cloudsContainer');
            for(let i=0; i<3; i++) spawnCloud(cont, isDark, true);
            cloudInterval = setInterval(() => spawnCloud(cont, isDark, false), 6000);
        }
        function spawnCloud(c, d, r) {
            const cl = document.createElement('div'); cl.classList.add('cloud'); if(d) cl.classList.add('dark');
            const w = Math.random() * 200 + 150; cl.style.width = w + "px"; cl.style.height = (w * 0.35) + "px";
            cl.style.top = (Math.random() * 30) + "vh"; cl.style.animationDuration = (Math.random() * 20 + 20) + "s";
            if (r) cl.style.left = (Math.random() * 100) + "vw"; else cl.style.left = -300 + "px";
            c.appendChild(cl); setTimeout(() => cl.remove(), parseFloat(cl.style.animationDuration) * 1000);
        }
        function startLightning() {
            const f = document.getElementById('flashOverlay');
            const r = () => { f.classList.add('flashing'); setTimeout(() => f.classList.remove('flashing'), 800); lightningTimeout = setTimeout(r, Math.random() * 5000 + 3000); };
            r();
        }
    </script>
</body>
</html>